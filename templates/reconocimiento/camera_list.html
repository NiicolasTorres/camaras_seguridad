{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de C√°maras{% endblock %}

{% block content %}
  <div class="form-group mb-3">
    <label for="ip-input">Ingrese la IP local de la c√°mara:</label>
    <input type="text" class="form-control" id="user-ip" placeholder="Ej: 192.168.1.5">
  </div>

  <button class="btn btn-primary" onclick="setDefaultCamera()">üîí Establecer como predeterminada</button>

  <!-- Vista de la c√°mara -->
  <div class="mt-3" id="camera-container" style="display:none;">
    <h4>üé• Vista de la c√°mara:</h4>
    <video id="video" controls autoplay style="width:100%; max-width:600px;"></video>
  </div>

  <div id="status-message" class="alert alert-info mt-3">
    Esperando para seleccionar c√°mara...
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    function isValidIP(ip) {
      return /^(\d{1,3}\.){3}\d{1,3}$/.test(ip);
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        for (let cookie of document.cookie.split(';')) {
          cookie = cookie.trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    async function detectCamera(ip) {
      const base = `${location.protocol}//${location.host}`;
      const endpoints = [
        { type: 'IP Webcam (MJPEG)',   url: `${base}/proxy_stream/${ip}/` },
      ];

      for (const e of endpoints) {
        try {
          const res = await fetch(e.url, { method: 'HEAD' });
          if (res.ok) return e.type;
        } catch {}
      }
      return null;
    }

    async function waitForPlaylist(url, attempts = 10) {
      for (let i = 0; i < attempts; i++) {
        try {
          const res = await fetch(url, { method: 'HEAD' });
          if (res.ok) return true;
        } catch {}
        await new Promise(r => setTimeout(r, 500));
      }
      return false;
    }

    async function setDefaultCamera() {
  const status = document.getElementById("status-message");
  const ip = document.getElementById('user-ip').value.trim();

  if (!isValidIP(ip)) {
    status.className = 'alert alert-danger';
    status.innerText = '‚ùå IP inv√°lida';
    return;
  }

  status.className = 'alert alert-info';
  status.innerText = 'üîí Intentando acceder a la c√°mara en tu red local...';

  const video = document.getElementById('video');
  const cameraUrl = `https://${ip}:8080/video`; // Puerto est√°ndar de IP Webcam o MJPEG

  // Probamos si est√° accesible
  try {
    const test = await fetch(cameraUrl, { method: 'HEAD' });
    if (!test.ok) throw new Error();

    video.src = cameraUrl;
    video.play();
    document.getElementById('camera-container').style.display = 'block';
    status.className = 'alert alert-success';
    status.innerText = 'üé¨ C√°mara conectada directamente desde tu red local.';

  } catch (err) {
    status.className = 'alert alert-danger';
    status.innerText = '‚ùå No se pudo acceder a la c√°mara en tu red local.';
  }
}

  </script>
{% endblock %}
