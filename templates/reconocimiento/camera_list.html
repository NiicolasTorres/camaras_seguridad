{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de Cámaras{% endblock %}

{% block content %}
  <h2 class="mt-4">Seleccionar Cámara Predeterminada</h2>

  <!-- IP input -->
  <div class="form-group mb-3">
    <label for="ip-input">Ingrese la IP local de la cámara:</label>
    <input type="text" class="form-control" id="user-ip" placeholder="Ej: 192.168.1.5">
  </div>

  <button class="btn btn-primary" onclick="setDefaultCamera()">🔒 Establecer como predeterminada</button>

  <!-- Status -->
  <div id="status-message" class="alert alert-info mt-3">
    Esperando para seleccionar cámara...
  </div>

  <script>
    function isValidIP(ip) {
      const regex = /^(\d{1,3}\.){3}\d{1,3}$/;
      return regex.test(ip);
    }

    async function setDefaultCamera() {
      const status = document.getElementById("status-message");
      const ip = document.getElementById('user-ip').value.trim();

      if (!isValidIP(ip)) {
        status.className = 'alert alert-danger';
        status.innerText = '❌ IP inválida';
        return;
      }

      status.className = 'alert alert-info';
      status.innerText = '🔒 Estableciendo cámara como predeterminada...';

      try {
        const res = await fetch('/register_and_set_default_camera', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ip })
        });

        const data = await res.json();

        if (res.ok) {
          status.className = 'alert alert-success';
          status.innerText = `✅ ${data.message}`;
        } else {
          status.className = 'alert alert-warning';
          status.innerText = `⚠️ ${data.error}`;
        }
      } catch (err) {
        console.error(err);
        status.className = 'alert alert-danger';
        status.innerText = '❌ Error al registrar la cámara.';
      }
    }
  </script>

{% endblock %}
