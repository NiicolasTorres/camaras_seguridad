{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de CÃ¡maras{% endblock %}

{% block content %}
<div class="form-group mb-3">
  <label for="ip-input">Ingrese la IP local de la cÃ¡mara:</label>
  <input type="text" class="form-control" id="user-ip" placeholder="Ej: 192.168.1.5">
</div>

<button class="btn btn-primary" onclick="setDefaultCamera()">ğŸ”’ Establecer como predeterminada</button>

<!-- Vista de la cÃ¡mara -->
<div class="mt-3" id="camera-container" style="display:none;">
  <h4>ğŸ¥ Vista de la cÃ¡mara:</h4>
  <video id="video" controls autoplay style="width:100%; max-width:600px;"></video>
</div>

<div id="status-message" class="alert alert-info mt-3">
  Esperando para seleccionar cÃ¡mara...
</div>

<!-- hls.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
  function isValidIP(ip) {
    const regex = /^(\d{1,3}\.){3}\d{1,3}$/;
    return regex.test(ip);
  }

  async function setDefaultCamera() {
    const status = document.getElementById("status-message");
    const ip = document.getElementById('user-ip').value.trim();

    if (!isValidIP(ip)) {
      status.className = 'alert alert-danger';
      status.innerText = 'âŒ IP invÃ¡lida';
      return;
    }

    status.className = 'alert alert-info';
    status.innerText = 'ğŸ”’ Estableciendo cÃ¡mara como predeterminada...';

    try {
      const res = await fetch('/register_and_set_default_camera/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          ip: ip,
          name: `CÃ¡mara ${ip}`
        })
      });

      let data;
      try {
        data = await res.json();
      } catch (err) {
        throw new Error("âš ï¸ La respuesta del servidor no es vÃ¡lida. Â¿EstÃ¡s logueado?");
      }

      if (res.ok) {
        status.className = 'alert alert-success';
        status.innerText = `âœ… ${data.message}`;
        document.getElementById('camera-container').style.display = 'block';

        // Usar hls.js para mostrar el stream
        const video = document.getElementById('video');
        const streamUrl = `https://${location.host}/hls/cam1.m3u8`; // Asegurate que la URL coincida

        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(streamUrl);
          hls.attachMedia(video);
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = streamUrl;
        } else {
          status.className = 'alert alert-danger';
          status.innerText = 'âŒ Tu navegador no soporta HLS.';
        }

      } else {
        status.className = 'alert alert-warning';
        status.innerText = `âš ï¸ ${data.error}`;
      }
    } catch (err) {
      console.error(err);
      status.className = 'alert alert-danger';
      status.innerText = `âŒ Error: ${err.message}`;
    }
  }
</script>
{% endblock %}
