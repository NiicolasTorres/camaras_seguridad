{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de C√°maras{% endblock %}

{% block content %}

  <h2 class="mt-4">Lista de C√°maras</h2>

  <!-- IP input -->
  <div class="form-group mb-3">
    <label for="ip-input">Ingrese tu IP local:</label>
    <input type="text" class="form-control" id="user-ip" placeholder="Ej: 192.168.1.5">
  </div>

  <button class="btn btn-primary" onclick="scanNetwork()">üîç Buscar c√°maras</button>

  <!-- Status -->
  <div id="status-message" class="alert alert-info mt-3">
    Esperando para detectar c√°maras...
  </div>

  <!-- Resultados -->
  <div class="row mt-3" id="camera-results"></div>

  <script>
    // Funci√≥n para validar si una IP es v√°lida (No debe ser .local)
    function isValidIP(ip) {
      const regex = /^(\d{1,3}\.){3}\d{1,3}$/;
      return regex.test(ip) && !ip.includes('.local');
    }

    // Obtener IPs locales usando RTCPeerConnection
    async function getLocalIPs() {
      const ips = new Set();
      const pc = new RTCPeerConnection({iceServers:[]});
      pc.createDataChannel('');
      pc.onicecandidate = e => {
        if (!e.candidate) {
          pc.close();
          return;
        }
        const parts = e.candidate.candidate.split(' ');
        const addr = parts[4];
        if (addr.includes('.')) ips.add(addr);
      };
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await new Promise(r => setTimeout(r, 500));
      return Array.from(ips).map(ip => ip.split('.').slice(0,3).join('.'));
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
  
    // Funci√≥n para escanear la red local en busca de c√°maras
    async function scanNetwork() {
      const status = document.getElementById("status-message");
      const container = document.getElementById("camera-results");
      status.className = 'alert alert-info';
      status.innerText = 'üîç Descubriendo c√°maras en LAN‚Ä¶';
      container.innerHTML = '';

      try {
        const res = await fetch('/scan-cameras/');
        const cams = await res.json();
        if (!cams.length) {
          status.className = 'alert alert-warning';
          status.innerText = '‚ö†Ô∏è No se encontraron c√°maras.';
          return;
        }
        status.className = 'alert alert-success';
        status.innerText = `‚úÖ ${cams.length} c√°maras encontradas:`;
        cams.forEach(({ name, ip, port }) => {
          const div = document.createElement('div');
          div.className = 'col-md-4 mb-4';
          div.innerHTML = `
            <div class="card p-3">
              <h5>${name}</h5>
              <p>${ip}:${port}</p>
              <a href="http://${ip}:${port}/video" target="_blank" class="btn btn-info btn-sm">Ver</a>
              <button class="btn btn-success btn-sm mt-2"
                onclick="selectCamera('${ip}:${port}', '', '${name}')">
                ‚úÖ Seleccionar
              </button>
            </div>`;
          container.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        status.className = 'alert alert-danger';
        status.innerText = '‚ùå Error conectando al esc√°ner local.';
      }
    }

    // Funci√≥n para probar si una IP tiene una c√°mara activa
    async function testCamera(ip) {
      const ports = [80, 8080, 8000, 554];
      const paths = ['', '/video', '/snapshot.jpg', '/favicon.ico'];
      for (let port of ports) {
        const tests = paths.map(path => {
          const url = `http://${ip}:${port}${path}`;
          console.log(`Probando: ${url}`);
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 400);
          return fetch(url, {
            method: 'HEAD',
            mode: 'no-cors',          
            signal: controller.signal
          })
          .then(res => {
            clearTimeout(timeout);
            console.log(`Respuesta recibida de ${url}`);
            return { ip, found: true, port };
          })
          .catch(_=> {
            console.log(`Error al contactar ${url}`);
            return null;
          });
        });
        const result = await Promise.race(tests);
        if (result) return result;
      }
      return { ip, found: false };
    }


    // Funci√≥n para seleccionar una c√°mara
    function selectCamera(ip, mac, name) {
      fetch('/register_and_set_default_camera', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip, mac, name, location: 'Asignada por usuario' })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
      })
      .catch(err => {
        alert("‚ùå Error al registrar la c√°mara.");
        console.error(err);
      });
    }
  </script>

{% endblock %}
