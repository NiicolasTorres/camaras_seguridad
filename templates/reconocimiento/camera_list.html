{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de C√°maras{% endblock %}

{% block content %}

  <h2 class="mt-4">Lista de C√°maras</h2>

  <!-- IP input -->
  <div class="form-group mb-3">
    <label for="ip-input">Ingrese tu IP local:</label>
    <input type="text" class="form-control" id="user-ip" placeholder="Ej: 192.168.1.5">
  </div>

  <button class="btn btn-primary" onclick="scanNetwork()">üîç Buscar c√°maras</button>

  <!-- Status -->
  <div id="status-message" class="alert alert-info mt-3">
    Esperando para detectar c√°maras...
  </div>

  <!-- Resultados -->
  <div class="row mt-3" id="camera-results"></div>

  <script>
    // Funci√≥n para validar si una IP es v√°lida (No debe ser .local)
    function isValidIP(ip) {
      const regex = /^(\d{1,3}\.){3}\d{1,3}$/;
      return regex.test(ip) && !ip.includes('.local');
    }

    // Obtener IPs locales usando RTCPeerConnection
    async function getLocalIPs() {
      const ips = new Set();
      const pc = new RTCPeerConnection({iceServers:[]});
      pc.createDataChannel('');
      pc.onicecandidate = e => {
        if (!e.candidate) {
          pc.close();
          return;
        }
        const parts = e.candidate.candidate.split(' ');
        const addr = parts[4];
        if (addr.includes('.')) ips.add(addr);
      };
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await new Promise(r => setTimeout(r, 500));
      return Array.from(ips).map(ip => ip.split('.').slice(0,3).join('.'));
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
  
    // Funci√≥n para escanear la red local en busca de c√°maras
    async function scanNetwork() {
      const status = document.getElementById("status-message");
      const container = document.getElementById("camera-results");
      status.innerText = "üîç Obteniendo tu IP local‚Ä¶";

      const bases = await getLocalIPs();
      console.log("IPs locales detectadas: ", bases); 
      if (!bases.length) {
        status.innerText = "No se pudo determinar tu IP local. Ingresala manualmente.";
        return;
      }
      status.innerText = `üîç Escaneando la red (${bases[0]}.0/24)‚Ä¶`;

      const base = bases[0];
      const ips = Array.from({length: 254}, (_, i) => `${base}.${i + 1}`).filter(isValidIP);
      console.log("IPs a escanear: ", ips); 

      const batchSize = 50;
      let found = [];

      for (let i = 0; i < ips.length; i += batchSize) {
        const batch = ips.slice(i, i + batchSize);
        const results = await Promise.all(batch.map(ip => testCamera(ip)));
        found = found.concat(results.filter(r => r.found));
        status.innerText = `üîç Escaneado ${Math.min(i + batchSize, ips.length)}/${ips.length} IPs‚Ä¶`;
      }

      container.innerHTML = '';
      if (!found.length) {
        status.innerText = "No se encontraron c√°maras.";
        return;
      }
      status.innerText = `${found.length} c√°maras detectadas:`;

      found.forEach(cam => {
        const div = document.createElement('div');
        div.className = "col-md-4 mb-4";
        div.innerHTML = `
          <div class="card p-3">
            <h5>C√°mara en ${cam.ip}:${cam.port}</h5>
            <a href="http://${cam.ip}:${cam.port}/video" target="_blank" class="btn btn-info btn-sm">‚ñ∂Ô∏è Ver</a>
            <button class="btn btn-success btn-sm mt-2"
               onclick="selectCamera('${cam.ip}:${cam.port}', '', 'Detectada frontend')">
              ‚úÖ Seleccionar
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Funci√≥n para probar si una IP tiene una c√°mara activa
    async function testCamera(ip) {
      const ports = [80, 8080, 8000, 554];
      const paths = ['', '/video', '/snapshot.jpg', '/favicon.ico'];
      for (let port of ports) {
        const tests = paths.map(path => {
          const url = `http://${ip}:${port}${path}`;
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 400);
          return fetch(url, {
            method: 'HEAD',
            mode: 'no-cors',          
            signal: controller.signal
          })
          .then(res => {
            clearTimeout(timeout);
            return { ip, found: true, port };
          })
          .catch(_=> null);
        });
        const result = await Promise.race(tests);
        if (result) return result;
      }
      return { ip, found: false };
    }

    // Funci√≥n para seleccionar una c√°mara
    function selectCamera(ip, mac, name) {
      fetch('/register_and_set_default_camera', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip, mac, name, location: 'Asignada por usuario' })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
      })
      .catch(err => {
        alert("‚ùå Error al registrar la c√°mara.");
        console.error(err);
      });
    }
  </script>

{% endblock %}
