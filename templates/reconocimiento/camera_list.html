{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de C√°maras{% endblock %}

{% block content %}

  <h2 class="mt-4">Lista de C√°maras</h2>

  <!-- IP input -->
  <div class="form-group mb-3">
    <label for="ip-input">Ingrese tu IP local:</label>
    <input type="text" class="form-control" id="user-ip" placeholder="Ej: 192.168.1.5">
  </div>

  <button class="btn btn-primary" onclick="scanNetwork()">üîç Buscar c√°maras</button>

  <!-- Status -->
  <div id="status-message" class="alert alert-info mt-3">
    Esperando para detectar c√°maras...
  </div>

  <!-- Resultados -->
  <div class="row mt-3" id="camera-results"></div>

  <script>

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');
  
  function scanNetwork() {
  const baseIp = document.getElementById("user-ip").value;
  const status = document.getElementById("status-message");
  const container = document.getElementById("camera-results");

  if (!baseIp) {
    status.innerText = "Por favor, ingres√° tu IP local.";
    return;
  }

  status.innerText = "üîç Escaneando la red desde tu navegador...";

  let ips = [];
  for (let i = 1; i < 255; i++) {
    ips.push(baseIp.split('.').slice(0, 3).join('.') + '.' + i);
  }

  container.innerHTML = '';

  Promise.all(
    ips.map(ip => testCamera(ip))
  ).then(results => {
    const found = results.filter(r => r.found);
    if (found.length === 0) {
      status.innerText = "No se encontraron c√°maras.";
    } else {
      status.innerText = `${found.length} c√°maras detectadas desde tu navegador.`;
    }

    found.forEach(cam => {
      const div = document.createElement('div');
      div.className = "col-md-4 mb-4";
      div.innerHTML = `
        <div class="card p-3">
          <h5>C√°mara en ${cam.ip}</h5>
          <a href="http://${cam.ip}:8080/video" target="_blank" class="btn btn-info btn-sm">‚ñ∂Ô∏è Ver c√°mara</a>
          <button class="btn btn-success btn-sm mt-2" onclick="selectCamera('${cam.ip}', '', 'Detectada desde frontend')">‚úÖ Seleccionar</button>
        </div>
      `;
      container.appendChild(div);
    });
  });
}

function testCamera(ip) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => resolve({ ip, found: true });
    const protocol = window.location.protocol === 'https:' ? 'https' : 'http';
    img.src = `/proxy-camera/${ip}/`;


  });
}


    function selectCamera(ip, mac, name) {
      fetch('/register_and_set_default_camera', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip, mac, name, location: 'Asignada por usuario' })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
      })
      .catch(err => {
        alert("‚ùå Error al registrar la c√°mara.");
        console.error(err);
      });
    }
  </script>
{% endblock %}
