{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de C√°maras{% endblock %}

{% block content %}
  <h2 class="mt-4">Lista de C√°maras</h2>

  <!-- IP input -->
  <div class="form-group mb-3">
    <label for="ip-input">Ingrese tu IP local:</label>
    <input type="text" class="form-control" id="user-ip" placeholder="Ej: 192.168.1.5">
  </div>

  <button class="btn btn-primary" onclick="scanNetwork()">üîç Buscar c√°maras</button>

  <!-- Status -->
  <div id="status-message" class="alert alert-info mt-3">
    Esperando para detectar c√°maras...
  </div>

  <!-- Resultados -->
  <div class="row mt-3" id="camera-results"></div>

  <script>
    function scanNetwork() {
      const baseIp = document.getElementById("user-ip").value;
      const status = document.getElementById("status-message");
      const container = document.getElementById("camera-results");

      if (!baseIp) {
        status.innerText = "Por favor, ingres√° tu IP local.";
        return;
      }

      status.innerText = "üîç Buscando c√°maras en la red...";

      let ips = [];
      for (let i = 1; i < 255; i++) {
        ips.push(baseIp.split('.').slice(0, 3).join('.') + '.' + i);
      }

      fetch('/cameras/reconocimiento/detect_cameras/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ips })
      })
      .then(res => res.json())
      .then(data => {
        container.innerHTML = '';
        const cameras = data.cameras;

        if (cameras.length === 0) {
          status.innerText = "No se encontraron c√°maras.";
        } else {
          status.innerText = `${cameras.length} c√°maras detectadas.`;
        }

        cameras.forEach(cam => {
          const div = document.createElement('div');
          div.className = "col-md-4 mb-4";

          div.innerHTML = `
            <div class="card p-3">
              <h5>${cam.name}</h5>
              <p><strong>IP:</strong> ${cam.ip}</p>
              ${cam.mac ? `<p><strong>MAC:</strong> ${cam.mac}</p>` : ''}
              <video src="${cam.url}" autoplay muted playsinline width="100%" class="mb-2"></video>
              <button class="btn btn-success btn-sm" onclick="selectCamera('${cam.ip}', '${cam.mac}', '${cam.name}')">‚úÖ Seleccionar</button>
            </div>
          `;

          container.appendChild(div);
        });
      })
      .catch(err => {
        status.innerText = "‚ùå Error al detectar c√°maras.";
        console.error(err);
      });
    }

    function selectCamera(ip, mac, name) {
      fetch('/register_and_set_default_camera', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip, mac, name, location: 'Asignada por usuario' })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
      })
      .catch(err => {
        alert("‚ùå Error al registrar la c√°mara.");
        console.error(err);
      });
    }
  </script>
{% endblock %}
