{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de Cámaras{% endblock %}

{% block content %}
  <h2 class="mt-4">Lista de Cámaras</h2>

  <!-- Campo para ingresar la IP -->
  <div class="form-group">
    <label for="ip-input">Ingrese la IP para buscar cámaras:</label>
    <input type="text" id="user-ip" placeholder="Tu IP local (ej: 192.100.0.10)">
  </div>

  <!-- Botón para iniciar la detección -->
  <button onclick="scanNetwork()">Buscar cámaras</button>

  <!-- Resultado de las cámaras detectadas -->
  <div class="row mt-3" id="camera-results"></div>

  <script>
    function scanNetwork() {
        const baseIp = document.getElementById("user-ip").value;
        let ips = [];
    
        for (let i = 1; i < 255; i++) {
            ips.push(baseIp.split('.').slice(0,3).join('.') + '.' + i);
        }
    
        fetch('/cameras/reconocimiento/detect_cameras/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ips})
        })
        .then(res => res.json())
        .then(data => {
            const cameras = data.cameras;
            const container = document.getElementById('camera-list');
            container.innerHTML = '';
    
            cameras.forEach(cam => {
                let div = document.createElement('div');
                div.innerHTML = `
                    <p>${cam.name} (${cam.ip})</p>
                    <video src="${cam.url}" autoplay width="200"></video>
                    <button onclick="selectCamera('${cam.ip}', '${cam.mac}', '${cam.name}')">Seleccionar</button>
                    <hr/>
                `;
                container.appendChild(div);
            });
        });
    }
    
    function selectCamera(ip, mac, name) {
        fetch('/register_and_set_default_camera', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ip, mac, name, location: 'Asignada por usuario'})
        })
        .then(res => res.json())
        .then(data => alert(data.message));
    }
    </script>

  <!-- Mensaje de estado -->
  <div id="status-message" class="alert alert-info">
    Esperando para detectar cámaras...
  </div>
{% endblock %}
