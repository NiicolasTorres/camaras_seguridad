{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de Cámaras{% endblock %}

{% block content %}
  <h2 class="mt-4">Lista de Cámaras</h2>

  <!-- Campo para ingresar la IP -->
  <div class="form-group">
    <label for="ip-input">Ingrese la IP para buscar cámaras:</label>
    <input type="text" id="user-ip" placeholder="Tu IP local (ej: 192.100.0.10)">
  </div>

  <!-- Botón para iniciar la detección -->
  <button onclick="scanNetwork()">Buscar cámaras</button>

  <!-- Resultado de las cámaras detectadas -->
  <div class="row mt-3" id="camera-results"></div>

  <script>
function scanNetwork() {
    const baseIp = document.getElementById("user-ip").value;
    let prefix = baseIp.split('.').slice(0, 3).join('.');
    let container = document.getElementById('camera-results');
    container.innerHTML = '';

    for (let i = 1; i < 255; i++) {
        let ip = `${prefix}.${i}`;
        let videoUrl = `http://${ip}:8080/video`;

        // Se prueba a cargar el video en un <video>, sin saber si va a funcionar (no-cors)
        let video = document.createElement('video');
        video.src = videoUrl;
        video.autoplay = true;
        video.muted = true; // algunos navegadores bloquean autoplay sin muted
        video.width = 200;
        video.onerror = () => {
            // si falla, no se muestra nada
        };
        video.onloadeddata = () => {
            let div = document.createElement('div');
            div.innerHTML = `
                <p>Posible cámara en ${ip}</p>
                <button onclick="selectCamera('${ip}', '', 'Cámara detectada')">Seleccionar</button>
                <hr/>
            `;
            div.appendChild(video);
            container.appendChild(div);
        };

        // aunque no se haya cargado aún, lo insertamos para que empiece a probar
        container.appendChild(video);
    }
}
    
    function selectCamera(ip, mac, name) {
        fetch('/register_and_set_default_camera', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ip, mac, name, location: 'Asignada por usuario'})
        })
        .then(res => res.json())
        .then(data => alert(data.message));
    }
    </script>

  <!-- Mensaje de estado -->
  <div id="status-message" class="alert alert-info">
    Esperando para detectar cámaras...
  </div>
{% endblock %}
