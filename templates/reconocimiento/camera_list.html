{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de C√°maras{% endblock %}

{% block content %}
  <div class="form-group mb-3">
    <label for="ip-input">Ingrese la IP local de la c√°mara:</label>
    <input type="text" class="form-control" id="user-ip" placeholder="Ej: 192.168.1.5">
  </div>

  <button class="btn btn-primary" onclick="setDefaultCamera()">üîí Establecer como predeterminada</button>

  <!-- Vista de la c√°mara -->
  <div class="mt-3" id="camera-container" style="display:none;">
    <h4>üé• Vista de la c√°mara:</h4>
    <video id="video" controls autoplay style="width:100%; max-width:600px;"></video>
  </div>

  <div id="status-message" class="alert alert-info mt-3">
    Esperando para seleccionar c√°mara...
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    function isValidIP(ip) {
      const regex = /^(\d{1,3}\.){3}\d{1,3}$/;
      return regex.test(ip);
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        for (let cookie of document.cookie.split(';')) {
          cookie = cookie.trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    async function detectCamera(ip) {
      const endpoints = [
        { type: 'IP Webcam', url: `http://${ip}:8080/video` }, // Para MJPEG en IP Webcam
        { type: 'IP Webcam (HLS)', url: `http://${ip}:8080/hls/stream.m3u8` }, // Para HLS en IP Webcam
        { type: 'Generic IP Camera', url: `http://${ip}/video` }, // Para c√°maras IP gen√©ricas
        { type: 'Generic IP Camera (HLS)', url: `http://${ip}/live/stream.m3u8` }
      ];

      for (const endpoint of endpoints) {
        try {
          const res = await fetch(endpoint.url, { method: 'HEAD' });
          if (res.ok) {
            return endpoint.type;  
          }
        } catch (err) {
          
        }
      }

      return null;  
    }

    async function waitForPlaylist(url, attempts = 10) {
      for (let i = 0; i < attempts; i++) {
        try {
          const res = await fetch(url, { method: 'HEAD' });
          if (res.ok) return true;
        } catch {}
        await new Promise(r => setTimeout(r, 500));
      }
      return false;
    }

    async function setDefaultCamera() {
      const status = document.getElementById("status-message");
      const ip = document.getElementById('user-ip').value.trim();

      if (!isValidIP(ip)) {
        status.className = 'alert alert-danger';
        status.innerText = '‚ùå IP inv√°lida';
        return;
      }

      status.className = 'alert alert-info';
      status.innerText = 'üîí Detectando tipo de c√°mara...';

      const cameraType = await detectCamera(ip);

      if (!cameraType) {
        status.className = 'alert alert-danger';
        status.innerText = '‚ùå No se pudo detectar el tipo de c√°mara.';
        return;
      }

      status.className = 'alert alert-info';
      status.innerText = `‚úÖ C√°mara detectada: ${cameraType}`;

      try {
        const res = await fetch('/register_and_set_default_camera/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ ip, name: `C√°mara ${ip}` })
        });
        const data = await res.json();

        if (!res.ok) {
          status.className = 'alert alert-warning';
          status.innerText = `‚ö†Ô∏è ${data.error}`;
          return;
        }

        const { stream_name } = data;

        status.className = 'alert alert-success';
        status.innerText = `‚úÖ ${data.message}`;
        document.getElementById('camera-container').style.display = 'block';

        const video = document.getElementById('video');
        const streamUrl = `https://${location.host}/hls/${stream_name}.m3u8`;

        status.className = 'alert alert-info';
        status.innerText = '‚åõ Preparando stream‚Ä¶';

        const ready = await waitForPlaylist(streamUrl, 10);
        if (!ready) {
          status.className = 'alert alert-danger';
          status.innerText = '‚ùå El stream a√∫n no est√° listo. Intenta de nuevo en unos segundos.';
          return;
        }

        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(streamUrl);
          hls.attachMedia(video);
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = streamUrl;
        } else {
          status.className = 'alert alert-danger';
          status.innerText = '‚ùå Tu navegador no soporta HLS.';
          return;
        }

        status.className = 'alert alert-success';
        status.innerText = '‚úÖ Reproduciendo stream.';
      } catch (err) {
        status.className = 'alert alert-danger';
        status.innerText = `‚ùå Error: ${err.message}`;
        return;
      }
    }
  </script>
{% endblock %}
