{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de C√°maras{% endblock %}

{% block content %}
<div class="form-group mb-3"> 
  <label for="user-ip">Ingrese la IP local de la c√°mara:</label>
  <input type="text" class="form-control" id="user-ip" placeholder="Ej: 192.168.1.5">
</div>

<button class="btn btn-primary" onclick="setDefaultCamera()">üîí Establecer como predeterminada</button>

<div class="mt-3" id="camera-container" style="display:none;">
  <h4>üé• Vista de la c√°mara:</h4>
  <video id="video" controls autoplay style="width:100%; max-width:600px;"></video>
</div>

<div id="status-message" class="alert alert-info mt-3">
  Esperando para seleccionar c√°mara...
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
function isValidIP(ip) {
  return /^(\d{1,3}\.){3}\d{1,3}$/.test(ip);
}

async function waitForPlaylist(url, attempts = 10) {
  for (let i = 0; i < attempts; i++) {
    try {
      const res = await fetch(url, { method: 'HEAD' });
      if (res.ok) return true;
    } catch {}
    await new Promise(r => setTimeout(r, 500));
  }
  return false;
}

async function detectStreamType(ip) {
    console.log("Entrando a detectStreamType");
    const base = "https://app.silenteye.com.mx";
    const proxyUrl = `${base}/proxy_stream/${ip}/`;

    await fetch(`${base}/start_stream/${ip}/`);

    const endpoints = [
      {
        type: 'HLS',
        url: `${base}/media_streams/${ip}.m3u8`,
        check: async (url) => await waitForPlaylist(url),
      },
      {
        type: 'MJPEG',
        url: proxyUrl,
        check: async (url) => {
          try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 500);
            const res = await fetch(url, { signal: controller.signal });
            clearTimeout(timeout);
            return res.ok;
          } catch {
            return false;
          }
        }
      }
    ];


    for (const endpoint of endpoints) {
      const ok = await endpoint.check(endpoint.url);
      if (ok) return endpoint;
    }

    return null;
}



async function setDefaultCamera() {
  const status = document.getElementById("status-message");
  const ip = document.getElementById('user-ip').value.trim();

  if (!isValidIP(ip)) {
    status.className = 'alert alert-danger';
    status.innerText = '‚ùå IP inv√°lida';
    return;
  }

  status.className = 'alert alert-info';
  status.innerText = 'üîç Detectando tipo de c√°mara...';

  const endpoint = await detectStreamType(ip);
  const video = document.getElementById('video');

  if (!endpoint) {
    status.className = 'alert alert-danger';
    status.innerText = '‚ùå No se pudo detectar ning√∫n stream disponible.';
    return;
  }

  document.getElementById('camera-container').style.display = 'block';

  if (endpoint.type === 'HLS') {
    if (Hls.isSupported()) {
      const hls = new Hls();
      hls.loadSource(endpoint.url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = endpoint.url;
      video.play();
    }
    status.className = 'alert alert-success';
    status.innerText = 'üé¨ C√°mara conectada v√≠a HLS.';
  } else if (endpoint.type === 'MJPEG') {
    video.src = endpoint.url;
    video.play();
    status.className = 'alert alert-success';
    status.innerText = 'üé¨ C√°mara conectada v√≠a MJPEG.';
  } else if (endpoint.type === 'WebRTC') {
    status.className = 'alert alert-info';
    status.innerText = 'üîÑ Conectando v√≠a WebRTC...';
    await startWebRTC(ip, video);
  }
}

async function startWebRTC(ip, videoElement) {
  try {
    const response = await fetch(`/webrtc_offer/${ip}/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    const data = await response.json();

    const iceServers = [
      {
        urls: 'turn:app.silenteye.com.mx:3478?transport=udp',
        username: 'usuario',
        credential: 'clave'
      },
      {
        urls: 'turn:app.silenteye.com.mx:5349?transport=tcp',
        username: 'usuario',
        credential: 'clave'
      },
      {
        urls: 'stun:app.silenteye.com.mx:3478'
      }
    ];

    const pc = new RTCPeerConnection({ iceServers });

    pc.ontrack = (event) => {
      videoElement.srcObject = event.streams[0];
      videoElement.play();
    };

    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    await fetch(`/webrtc_answer/${ip}/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ answer: pc.localDescription })
    });
  } catch (err) {
    const status = document.getElementById("status-message");
    status.className = 'alert alert-danger';
    status.innerText = '‚ùå Error al conectar por WebRTC.';
  }
}

</script>
{% endblock %}
