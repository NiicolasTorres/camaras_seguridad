{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de CÃ¡maras{% endblock %}

{% block content %}

  <h2 class="mt-4">Lista de CÃ¡maras</h2>

  <!-- IP input -->
  <div class="form-group mb-3">
    <label for="ip-input">Ingrese la IP local:</label>
    <input type="text" class="form-control" id="user-ip" placeholder="Ej: 192.168.1.5">
  </div>

  <button class="btn btn-primary" onclick="scanNetwork()">ğŸ” Buscar cÃ¡maras</button>

  <!-- Status -->
  <div id="status-message" class="alert alert-info mt-3">
    Esperando para detectar cÃ¡maras...
  </div>

  <!-- Resultados -->
  <div class="row mt-3" id="camera-results"></div>

  <script>
    function isValidIP(ip) {
      const regex = /^(\d{1,3}\.){3}\d{1,3}$/;
      return regex.test(ip);
    }

    // FunciÃ³n para escanear la red local en busca de cÃ¡maras
    async function scanNetwork() {
      const status = document.getElementById("status-message");
      const container = document.getElementById("camera-results");
      container.innerHTML = '';
      const manual = document.getElementById('user-ip').value.trim();

      // Validamos si la IP ingresada es vÃ¡lida
      if (!isValidIP(manual)) {
        status.className = 'alert alert-danger';
        status.innerText = 'âŒ IP invÃ¡lida';
        return;
      }

      const base = manual.split('.').slice(0,3).join('.'); 
      status.className = 'alert alert-info';
      status.innerText = `ğŸ” Escaneando ${base}.0/24â€¦`;

      try {
        // Llamamos al backend para escanear cÃ¡maras en la IP pÃºblica
        const res = await fetch(`/scan-cameras/?base=${manual}`);
        const cams = await res.json();

        if (!cams.length) {
          status.className = 'alert alert-warning';
          status.innerText = 'âš ï¸ No se encontraron cÃ¡maras.';
          return;
        }

        status.className = 'alert alert-success';
        status.innerText = `âœ… ${cams.length} cÃ¡maras encontradas:`;

        cams.forEach(({ name, ip, port }) => {
          const div = document.createElement('div');
          div.className = 'col-md-4 mb-4';
          div.innerHTML = `
            <div class="card p-3">
              <h5>${name}</h5>
              <p>${ip}:${port}</p>
              <button class="btn btn-success btn-sm mt-2" onclick="selectCamera('${ip}:${port}', '${name}')">âœ… Seleccionar como predeterminada</button>
            </div>`;
          container.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        status.className = 'alert alert-danger';
        status.innerText = 'âŒ Error al escanear la LAN.';
      }
    }

    // FunciÃ³n para seleccionar una cÃ¡mara como predeterminada
    function selectCamera(ip, name) {
      fetch('/register_and_set_default_camera', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip, name })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
      })
      .catch(err => {
        alert("âŒ Error al registrar la cÃ¡mara.");
        console.error(err);
      });
    }
  </script>

{% endblock %}
